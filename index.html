<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador de TrÃ¡fico en Marte</title>
  <style>
    body {
      font-family: sans-serif;
      background: #2c2c2c;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(100, 10px);
      grid-template-rows: repeat(100, 10px);
      margin: 10px 0;
    }

    .cell {
      width: 10px;
      height: 10px;
      background: #3a2a1e;
      border: 0.5px solid #2c2c2c;
      position: relative;
      user-select: none;
    }

    .road {
      background: #8b5e3c;
    }

    .start-flag, .end-flag {
      font-size: 8px;
      position: absolute;
      top: -2px;
      left: -1px;
    }

    .car {
      font-size: 8px;
      position: absolute;
      top: -2px;
      left: -1px;
      pointer-events: none;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    button {
      background: #5a5a5a;
      border: none;
      padding: 5px 10px;
      color: white;
      cursor: pointer;
    }

    .money {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <h2>TrÃ¡fico en Marte ðŸš—</h2>
  <div class="money">ðŸ’° Dinero: $<span id="money">1000000</span></div>
  <div class="controls">
    <button onclick="setMode('add')">Agregar carretera</button>
    <button onclick="setMode('remove')">Quitar carretera</button>
    <button onclick="resetRoads()">Reiniciar carreteras</button>
    <button onclick="startSimulation()">Iniciar simulaciÃ³n</button>
  </div>
  <div class="grid" id="grid"></div>

  <script>
    const gridSize = 100;
    const grid = document.getElementById("grid");
    let mode = "add";
    let isDragging = false;
    let matrix = [];
    let cars = [];
    let money = 1000;

    function setMode(m) {
      mode = m;
    }

    function updateMoney() {
      document.getElementById("money").textContent = money;
    }

    function resetRoads() {
      matrix = Array.from({ length: gridSize }, () => Array(gridSize).fill(0));
      document.querySelectorAll(".cell").forEach(cell => {
        cell.classList.remove("road");
        cell.innerHTML = '';
      });
      placeFlags();
      money = 1000;
      updateMoney();
    }

    function createGrid() {
      grid.innerHTML = "";
      matrix = Array.from({ length: gridSize }, () => Array(gridSize).fill(0));

      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.x = x;
          cell.dataset.y = y;

          cell.addEventListener("mousedown", () => {
            isDragging = true;
            toggleRoad(cell);
          });

          cell.addEventListener("mouseover", () => {
            if (isDragging) toggleRoad(cell);
          });

          grid.appendChild(cell);
        }
      }

      document.addEventListener("mouseup", () => isDragging = false);
      placeFlags();
    }

    function placeFlags() {
      const startCell = getCell(0, 0);
      const endCell = getCell(99, 99);
      if (startCell) startCell.innerHTML = `<div class="start-flag">ðŸš©</div>`;
      if (endCell) endCell.innerHTML = `<div class="end-flag">ðŸš©</div>`;
    }

    function getCell(x, y) {
      return grid.children[y * gridSize + x];
    }

    function toggleRoad(cell) {
      const x = parseInt(cell.dataset.x);
      const y = parseInt(cell.dataset.y);

      if (mode === "add" && matrix[y][x] === 0 && money >= 10) {
        matrix[y][x] = 1;
        cell.classList.add("road");
        money -= 10;
        updateMoney();
      } else if (mode === "remove" && matrix[y][x] === 1) {
        matrix[y][x] = 0;
        cell.classList.remove("road");
        cell.innerHTML = '';
        placeFlags();
        money += 10;
        updateMoney();
      }
    }

    function bfs(start, end, mat) {
      const visited = Array.from({ length: gridSize }, () => Array(gridSize).fill(false));
      const queue = [[start]];
      visited[start.y][start.x] = true;

      while (queue.length > 0) {
        const path = queue.shift();
        const { x, y } = path[path.length - 1];

        if (x === end.x && y === end.y) return path;

        const directions = [
          { x: 0, y: -1 }, { x: 0, y: 1 },
          { x: -1, y: 0 }, { x: 1, y: 0 }
        ];

        for (const d of directions) {
          const nx = x + d.x;
          const ny = y + d.y;

          if (nx >= 0 && ny >= 0 && nx < gridSize && ny < gridSize &&
              mat[ny][nx] === 1 && !visited[ny][nx]) {
            visited[ny][nx] = true;
            queue.push([...path, { x: nx, y: ny }]);
          }
        }
      }

      return null;
    }

    function createCar(index) {
      const car = document.createElement("div");
      car.classList.add("car");
      car.textContent = "ðŸš—";
      grid.appendChild(car);
      return { div: car };
    }

    function moveAllCars() {
      const occupied = {};

      function moveStep() {
        cars.forEach(car => {
          if (car.stepIndex < car.path.length) {
            const pos = car.path[car.stepIndex];
            const key = `${pos.x},${pos.y}`;

            if (occupied[key]) {
              // choque
              car.div.textContent = "ðŸš—";
              car.div.style.color = "red";
              occupied[key].div.textContent = "ðŸš—";
              occupied[key].div.style.color = "red";
            } else {
              occupied[key] = car;
              car.div.style.left = `${pos.x * 10}px`;
              car.div.style.top = `${pos.y * 10}px`;
            }

            car.stepIndex++;
          }
        });

        if (cars.some(c => c.stepIndex < c.path.length)) {
          requestAnimationFrame(moveStep);
        }
      }

      moveStep();
    }

    function startSimulation() {
      const start = { x: 0, y: 0 };
      const end = { x: 99, y: 99 };

      if (matrix[start.y][start.x] !== 1 || matrix[end.y][end.x] !== 1) {
        alert("La posiciÃ³n de inicio o destino no estÃ¡ en carretera");
        return;
      }

      cars.forEach(c => c.div.remove());
      cars = [];

      const numberOfCars = 5;

      for (let i = 0; i < numberOfCars; i++) {
        const car = createCar(i);
        const route = bfs(start, end, matrix);
        if (!route) {
          alert("No se encontrÃ³ ruta desde el inicio al destino");
          return;
        }
        car.path = route;
        car.stepIndex = 0;
        cars.push(car);
      }

      moveAllCars();
    }

    createGrid();
    updateMoney();
  </script>
</body>
</html>
