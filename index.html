// ... tu código previo para grid y roads

function buildRoadMatrix() {
  const matrix = Array(rows).fill(null).map(() => Array(cols).fill(0));
  roads.forEach(({x, y}) => {
    matrix[y][x] = 1;
  });
  return matrix;
}

function bfs(start, end, matrix) {
  const queue = [];
  const visited = new Set();
  const parent = {};
  
  function key(pos) { return pos.x + ',' + pos.y; }
  
  queue.push(start);
  visited.add(key(start));
  
  while(queue.length > 0) {
    const current = queue.shift();
    if(current.x === end.x && current.y === end.y) {
      // reconstruir ruta
      const path = [];
      let curKey = key(end);
      while(curKey !== key(start)) {
        const [x,y] = curKey.split(',').map(Number);
        path.push({x,y});
        curKey = parent[curKey];
      }
      path.push(start);
      path.reverse();
      return path;
    }
    
    const directions = [
      {x: current.x, y: current.y -1},
      {x: current.x, y: current.y +1},
      {x: current.x -1, y: current.y},
      {x: current.x +1, y: current.y}
    ];
    
    for(const next of directions) {
      if(next.x >= 0 && next.x < cols && next.y >=0 && next.y < rows) {
        if(matrix[next.y][next.x] === 1) {
          const nextKey = key(next);
          if(!visited.has(nextKey)) {
            queue.push(next);
            visited.add(nextKey);
            parent[nextKey] = key(current);
          }
        }
      }
    }
  }
  
  return null; // sin ruta
}

let carDiv = null;
let path = [];
let stepIndex = 0;

function startCarMovement(route) {
  if(!carDiv) {
    carDiv = document.createElement('div');
    carDiv.classList.add('car');
    document.body.appendChild(carDiv);
  }
  path = route;
  stepIndex = 0;
  moveStep();
}

function moveStep() {
  if(stepIndex >= path.length) {
    alert("El auto llegó al destino");
    return;
  }
  const pos = path[stepIndex];
  carDiv.style.left = (pos.x * 10 + 1) + 'px';
  carDiv.style.top = (pos.y * 10 + 2) + 'px';
  
  stepIndex++;
  setTimeout(moveStep, 200);
}

// Botón para iniciar ruta y movimiento del auto
function startSimulation() {
  if(roads.length === 0) {
    alert("Por favor construye carreteras para que el auto pueda moverse.");
    return;
  }
  
  const matrix = buildRoadMatrix();
  const start = {x: 0, y: 0};
  const end = {x: 10, y: 10}; // Cambia al destino que quieras, asegúrate que sea carretera
  
  if(matrix[start.y][start.x] !== 1 || matrix[end.y][end.x] !== 1) {
    alert("La posición de inicio o destino no está en carretera");
    return;
  }
  
  const route = bfs(start, end, matrix);
  if(route) {
    startCarMovement(route);
  } else {
    alert("No se encontró ruta desde el inicio al destino");
  }
}

// Agrega un botón en tu HTML para probar:
const hud = document.querySelector('.hud');
const btnSim = document.createElement('button');
btnSim.textContent = 'Iniciar Simulación';
btnSim.onclick = startSimulation;
hud.appendChild(btnSim);
