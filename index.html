<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simulador Marte</title>
  <style>
    body {
      font-family: sans-serif;
      background: #2e1d17;
      color: white;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(100, 10px);
      grid-template-rows: repeat(100, 10px);
      gap: 1px;
      margin: 20px auto;
      width: fit-content;
    }
    .cell {
      width: 10px;
      height: 10px;
      background: #703e30;
      user-select: none;
    }
    .road {
      background: #bbb;
    }
    .car {
      position: absolute;
      font-size: 10px;
      pointer-events: none;
    }
    .controls {
      margin-bottom: 10px;
    }
    .flag {
      font-size: 10px;
      pointer-events: none;
      position: absolute;
    }
  </style>
</head>
<body>
  <h1>Simulador de Tr√°fico en Marte</h1>
  <div class="controls">
    <button onclick="setMode('add')">Agregar carretera</button>
    <button onclick="setMode('remove')">Quitar carretera</button>
    <button onclick="resetRoads()">Reiniciar carreteras</button>
    <button onclick="startSimulation()">Iniciar Simulaci√≥n</button>
    <div>Dinero: $<span id="money">100000</span></div>
  </div>
  <div id="grid" class="grid"></div>

  <script>
    const gridElement = document.getElementById('grid');
    const moneyDisplay = document.getElementById('money');
    let money = 100000;
    let mode = 'add';
    const size = 100;
    let isMouseDown = false;
    let matrix = [];
    let cells = [];
    let cars = [];

    function updateMoney() {
      moneyDisplay.textContent = money;
    }

    function setMode(newMode) {
      mode = newMode;
    }

    function createGrid() {
      matrix = Array.from({ length: size }, () => Array(size).fill(0));
      cells = [];
      gridElement.innerHTML = '';

      for (let y = 0; y < size; y++) {
        const row = [];
        for (let x = 0; x < size; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          gridElement.appendChild(cell);
          row.push(cell);
        }
        cells.push(row);
      }

      // Bandera inicio
      const flagStart = document.createElement('div');
      flagStart.textContent = 'üèÅ';
      flagStart.className = 'flag';
      flagStart.style.top = '0px';
      flagStart.style.left = '0px';
      flagStart.style.transform = 'translate(0, 0)';
      flagStart.style.position = 'absolute';
      gridElement.appendChild(flagStart);

      // Bandera final
      const flagEnd = document.createElement('div');
      flagEnd.textContent = 'üèÅ';
      flagEnd.className = 'flag';
      flagEnd.style.top = `${(size - 1) * 11}px`;
      flagEnd.style.left = `${(size - 1) * 11}px`;
      flagEnd.style.transform = 'translate(0, 0)';
      flagEnd.style.position = 'absolute';
      gridElement.appendChild(flagEnd);

      addMouseEvents();
    }

    function addMouseEvents() {
      gridElement.onmousedown = () => isMouseDown = true;
      gridElement.onmouseup = () => isMouseDown = false;

      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          const cell = cells[y][x];
          cell.onmouseover = () => {
            if (!isMouseDown) return;
            handleCell(x, y);
          };
          cell.onclick = () => handleCell(x, y);
        }
      }
    }

    function handleCell(x, y) {
      if (x === 0 && y === 0) return;
      if (x === 99 && y === 99) return;

      if (mode === 'add' && matrix[y][x] === 0 && money >= 10) {
        matrix[y][x] = 1;
        cells[y][x].classList.add('road');
        money -= 10;
      } else if (mode === 'remove' && matrix[y][x] === 1) {
        matrix[y][x] = 0;
        cells[y][x].classList.remove('road');
        money += 10;
      }
      updateMoney();
    }

    function resetRoads() {
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          if ((x !== 0 || y !== 0) && (x !== 99 || y !== 99)) {
            matrix[y][x] = 0;
            cells[y][x].classList.remove('road');
          }
        }
      }
      money = 100000;
      updateMoney();
    }

    function bfs(start, end, matrix) {
      const queue = [ [start] ];
      const visited = new Set();
      visited.add(`${start.x},${start.y}`);

      while (queue.length > 0) {
        const path = queue.shift();
        const { x, y } = path[path.length - 1];

        if (x === end.x && y === end.y) return path;

        for (const [dx, dy] of [[1,0],[-1,0],[0,1],[0,-1]]) {
          const nx = x + dx, ny = y + dy;
          if (nx >= 0 && ny >= 0 && nx < size && ny < size &&
              matrix[ny][nx] === 1 && !visited.has(`${nx},${ny}`)) {
            visited.add(`${nx},${ny}`);
            queue.push([...path, { x: nx, y: ny }]);
          }
        }
      }

      return null;
    }

    function createCar(i) {
      const car = document.createElement('div');
      car.className = 'car';
      car.textContent = 'üöó';
      gridElement.appendChild(car);
      return { div: car, stepIndex: 0, path: [] };
    }

    function moveAllCars() {
      function moveStep() {
        const positions = new Map();

        cars.forEach(car => {
          if (car.stepIndex < car.path.length) {
            const pos = car.path[car.stepIndex];
            const key = `${pos.x},${pos.y}`;

            if (positions.has(key)) {
              car.div.textContent = 'üöóüî¥';
              positions.get(key).div.textContent = 'üöóüî¥';
            } else {
              positions.set(key, car);
              car.div.style.left = `${pos.x * 11}px`;
              car.div.style.top = `${pos.y * 11}px`;
              car.div.textContent = 'üöó';
            }

            car.stepIndex++;
          }
        });

        if (cars.some(c => c.stepIndex < c.path.length)) {
          requestAnimationFrame(moveStep);
        }
      }

      requestAnimationFrame(moveStep);
    }

    function startSimulation() {
      const start = { x: 0, y: 0 };
      const end = { x: 99, y: 99 };

      if (matrix[start.y][start.x] !== 1 || matrix[end.y][end.x] !== 1) {
        alert("Inicio o destino no est√° en carretera.");
        return;
      }

      cars.forEach(c => c.div.remove());
      cars = [];

      for (let i = 0; i < 5; i++) {
        const car = createCar(i);
        const route = bfs(start, end, matrix);
        if (!route) {
          alert("No hay ruta disponible.");
          return;
        }
        car.path = route;
        car.stepIndex = 0;
        cars.push(car);
      }

      moveAllCars();
    }

    createGrid();
    updateMoney();
  </script>
</body>
</html>
